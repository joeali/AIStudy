"""
æ™ºèƒ½åˆ†æžæ¨¡å— - åˆ¤æ–­è¯•å·ç±»åž‹å¹¶æ‰§è¡Œç›¸åº”åˆ†æž
- æ•´å¼ è¯•å·ï¼ˆâ‰¥3é“é”™é¢˜ï¼‰â†’ å­¦æƒ…åˆ†æž
- å•ä¸ªé”™é¢˜ï¼ˆ1-2é“é¢˜ï¼‰â†’ é’ˆå¯¹æ€§è®²è§£
"""

import json
import re

# å­¦æƒ…åˆ†æžæ¨¡æ¿ï¼ˆå‚è€ƒè‹±è¯­åˆ†æžæ¨¡æ¿ï¼‰
LEARNING_ANALYSIS_TEMPLATE = """ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„æ•™è‚²ä¸“å®¶ï¼Œæ“…é•¿åˆ†æžå­¦ç”Ÿçš„è¯•å·å¹¶æä¾›è¯¦ç»†çš„å­¦æƒ…åˆ†æžã€‚

è¯·æ ¹æ®å­¦ç”Ÿè¯•å·çš„ç­”é¢˜æƒ…å†µï¼ŒæŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç”Ÿæˆè¯¦ç»†çš„å­¦æƒ…åˆ†æžæŠ¥å‘Šï¼š

---

## ä¸€ã€å­¦ä¹ çŽ°çŠ¶åˆ†æž

ä»Žå·é¢åé¦ˆæ¥çœ‹ï¼Œè¯·åˆ†æžå­¦ç”Ÿçš„å­¦ä¹ ä¼˜åŠ¿ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºŽï¼š
- åŸºç¡€çŸ¥è¯†æŽŒæ¡æƒ…å†µ
- è§£é¢˜èƒ½åŠ›è¡¨çŽ°
- å­¦ä¹ ä¹ æƒ¯å’Œæ€åº¦
- å€¼å¾—è‚¯å®šçš„æ–¹é¢

## äºŒã€è–„å¼±ç‚¹ä¸Žå¤±åˆ†åŽŸå› åˆ†æž

è¯·è¯¦ç»†åˆ†æžå­¦ç”Ÿçš„è–„å¼±çŽ¯èŠ‚ï¼ŒæŒ‰é¢˜åž‹æˆ–çŸ¥è¯†ç‚¹åˆ†ç±»ï¼š

**å¤±åˆ†ç‚¹1ï¼š[é¢˜åž‹/çŸ¥è¯†ç‚¹]**
- é¢˜å·ï¼šåˆ—å‡ºç›¸å…³é¢˜å·
- æ­£ç¡®ç­”æ¡ˆï¼šç»™å‡ºæ­£ç¡®ç­”æ¡ˆ
- å­¦ç”Ÿç­”æ¡ˆï¼šå­¦ç”Ÿçš„é”™è¯¯ç­”æ¡ˆ
- æ·±åº¦åˆ†æžï¼šä¸ºä»€ä¹ˆå‡ºé”™ï¼Ÿæ¦‚å¿µä¸æ¸…/æ–¹æ³•ä¸å¯¹/è®¡ç®—å¤±è¯¯/å®¡é¢˜ä¸æ¸…ï¼Ÿå…·ä½“æ˜¯å“ªä¸ªçŽ¯èŠ‚å‡ºäº†é—®é¢˜ï¼Ÿ
- å…¸åž‹é”™è¯¯ï¼šæè¿°å­¦ç”ŸçŠ¯çš„å…·ä½“é”™è¯¯

**å¤±åˆ†ç‚¹2ï¼š[é¢˜åž‹/çŸ¥è¯†ç‚¹]**
- ï¼ˆåŒä¸Šç»“æž„ï¼‰

**å¤±åˆ†ç‚¹3ï¼š[é¢˜åž‹/çŸ¥è¯†ç‚¹]**
- ï¼ˆåŒä¸Šç»“æž„ï¼‰

## ä¸‰ã€å­¦ä¹ å»ºè®®

é’ˆå¯¹ä¸Šè¿°è–„å¼±ç‚¹ï¼Œç»™å‡ºå…·ä½“ã€å¯æ“ä½œçš„å­¦ä¹ å»ºè®®ï¼š

### é’ˆå¯¹æ€§æå‡å»ºè®®
1. **å»ºè®®1**ï¼šå…·ä½“çš„å­¦ä¹ æ–¹æ³•æˆ–ç»ƒä¹ ç­–ç•¥
2. **å»ºè®®2**ï¼šé’ˆå¯¹æŸä¸ªè–„å¼±ç‚¹çš„æ”¹è¿›æ–¹æ¡ˆ
3. **å»ºè®®3**ï¼šå­¦ä¹ ä¹ æƒ¯æˆ–æŠ€å·§æ–¹é¢çš„å»ºè®®

### æ¯æ—¥ç»ƒä¹ è®¡åˆ’
- [ ] ç»ƒä¹ å†…å®¹1ï¼ˆå…·ä½“é¢˜åž‹å’Œæ•°é‡ï¼‰
- [ ] ç»ƒä¹ å†…å®¹2
- [ ] ç»ƒä¹ å†…å®¹3

## å››ã€çŸ¥è¯†ç‚¹æ¢³ç†

åˆ—å‡ºæœ¬æ¬¡è¯•å·æ¶‰åŠçš„æ ¸å¿ƒçŸ¥è¯†ç‚¹åŠæŽŒæ¡æƒ…å†µï¼š

| çŸ¥è¯†ç‚¹ | æŽŒæ¡ç¨‹åº¦ | éœ€è¦åŠ å¼º |
|--------|----------|----------|
| çŸ¥è¯†ç‚¹1 | â­â­â­ / â­â­ / â­ | è¯´æ˜Ž |
| çŸ¥è¯†ç‚¹2 | â­â­â­ / â­â­ / â­ | è¯´æ˜Ž |

## äº”ã€ä¸‹æ¬¡è€ƒè¯•ç›®æ ‡

åŸºäºŽæœ¬æ¬¡åˆ†æžï¼Œè®¾å®šå…·ä½“ã€å¯è¡¡é‡çš„æå‡ç›®æ ‡ï¼š

- **ç›®æ ‡åˆ†æ•°**ï¼šå…·ä½“çš„åˆ†æ•°ç›®æ ‡
- **é‡ç‚¹çªç ´**ï¼šéœ€è¦é‡ç‚¹æŽŒæ¡çš„çŸ¥è¯†ç‚¹
- **æåˆ†ç­–ç•¥**ï¼šå¦‚ä½•å®žçŽ°ç›®æ ‡

---

è¦æ±‚ï¼š
1. åˆ†æžè¦è¯¦ç»†ã€å…·ä½“ï¼Œé¿å…ç©ºæ³›
2. å¤±åˆ†åŽŸå› è¦æ·±å…¥åˆ°å…·ä½“çŽ¯èŠ‚
3. å­¦ä¹ å»ºè®®è¦å¯æ“ä½œã€å¯æ‰§è¡Œ
4. ç”¨è¯é¼“åŠ±æ€§å¼ºï¼Œæ—¢æŒ‡å‡ºé—®é¢˜ä¹Ÿç»™äºˆè‚¯å®š
5. é€‚åˆå­¦ç”Ÿå’Œå®¶é•¿é˜…è¯»ç†è§£

çŽ°åœ¨è¯·æ ¹æ®æ£€æµ‹åˆ°çš„é”™é¢˜ï¼Œç”Ÿæˆå­¦æƒ…åˆ†æžæŠ¥å‘Šï¼š
"""

# é”™é¢˜è®²è§£æ¨¡æ¿ï¼ˆé’ˆå¯¹æ€§æé—®å’Œå¼•å¯¼ï¼‰
MISTAKE_GUIDE_TEMPLATE = """ä½ æ˜¯ä¸€ä½è€å¿ƒçš„è€å¸ˆï¼Œæ­£åœ¨å¸®åŠ©å­¦ç”Ÿç†è§£é”™é¢˜ã€‚

è¯·æŒ‰ç…§è‹æ ¼æ‹‰åº•å¼å¼•å¯¼æ–¹æ³•ï¼Œé€šè¿‡æé—®å¼•å¯¼å­¦ç”Ÿè‡ªå·±æ‰¾åˆ°ç­”æ¡ˆï¼Œè€Œä¸æ˜¯ç›´æŽ¥ç»™å‡ºè§£é¢˜æ­¥éª¤ã€‚

## å¼•å¯¼æµç¨‹ï¼š

**ç¬¬ä¸€æ­¥ï¼šç†è§£é¢˜ç›®**
- æé—®1ï¼šå¼•å¯¼å­¦ç”Ÿç†è§£é¢˜ç›®åœ¨é—®ä»€ä¹ˆ
- æé—®2ï¼šå¸®åŠ©å­¦ç”Ÿè¯†åˆ«å·²çŸ¥æ¡ä»¶å’Œè¦æ±‚

**ç¬¬äºŒæ­¥ï¼šå›žé¡¾çŸ¥è¯†ç‚¹**
- æé—®3ï¼šå¼•å¯¼å­¦ç”Ÿå›žé¡¾ç›¸å…³çš„çŸ¥è¯†ç‚¹æˆ–å…¬å¼
- æé—®4ï¼šæ£€æŸ¥å­¦ç”Ÿæ˜¯å¦æŽŒæ¡åŸºç¡€æ¦‚å¿µ

**ç¬¬ä¸‰æ­¥ï¼šå¯å‘æ€è·¯**
- æé—®5ï¼šæç¤ºè§£é¢˜æ€è·¯çš„æ–¹å‘ï¼ˆä¸ç›´æŽ¥è¯´ç­”æ¡ˆï¼‰
- æé—®6ï¼šå¼•å¯¼å­¦ç”Ÿæ€è€ƒç¬¬ä¸€æ­¥è¯¥æ€Žä¹ˆåš

**ç¬¬å››æ­¥ï¼šæ·±å…¥å¼•å¯¼**
- æ ¹æ®å­¦ç”Ÿçš„å›žç­”ï¼Œç»™å‡ºé€’è¿›å¼çš„æç¤º
- å¦‚æžœå­¦ç”Ÿå›žç­”æ­£ç¡®ï¼Œç»™äºˆè‚¯å®šå¹¶æŽ¨è¿›
- å¦‚æžœå­¦ç”Ÿå›žç­”é”™è¯¯ï¼Œå§”å©‰æŒ‡å‡ºå¹¶ç»™å‡ºæç¤º

## æ•™å­¦åŽŸåˆ™ï¼š
1. âŒ ä¸è¦ç›´æŽ¥ç»™å‡ºç­”æ¡ˆæˆ–å®Œæ•´è§£é¢˜æ­¥éª¤
2. âœ… æ¯æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜
3. âœ… ä½¿ç”¨å¯å‘å¼æé—®ï¼š"ä½ è§‰å¾—...ï¼Ÿ""ä¸ºä»€ä¹ˆä¼š...ï¼Ÿ""ä½ æ³¨æ„åˆ°...å—ï¼Ÿ"
4. âœ… ç»™äºˆé¼“åŠ±å’Œè‚¯å®š
5. âœ… ä»Žå­¦ç”Ÿçš„é”™è¯¯ä¸­å­¦ä¹ ï¼Œåˆ†æžé”™è¯¯åŽŸå› 

## å“åº”æ ¼å¼ï¼š

```
ðŸ“‹ **é”™é¢˜åˆ†æž**

ã€é¢˜ç›®ã€‘
é¢˜ç›®å†…å®¹...

ã€ä½ çš„ç­”æ¡ˆã€‘
å­¦ç”Ÿçš„ç­”æ¡ˆ...

ã€æ­£ç¡®ç­”æ¡ˆã€‘
æ­£ç¡®ç­”æ¡ˆ...

ã€é”™è¯¯åŽŸå› ã€‘
åˆ†æžä¸ºä»€ä¹ˆå‡ºé”™...

---

ðŸ‘¨â€ðŸ« **å¼•å¯¼å¼€å§‹**

**è€å¸ˆ**ï¼š[ç¬¬ä¸€ä¸ªå¼•å¯¼é—®é¢˜]
ï¼ˆå¼•å¯¼å­¦ç”Ÿæ€è€ƒï¼‰

ðŸ’¡ è¯·å›žç­”è€å¸ˆçš„é—®é¢˜ï¼Œæˆ‘ä¼šä¸€æ­¥æ­¥å¼•å¯¼ä½ ç†è§£è¿™é“é¢˜ã€‚

ï¼ˆè¾“å…¥ä½ çš„ç­”æ¡ˆï¼Œè€å¸ˆä¼šç»§ç»­å¼•å¯¼ï¼‰
```

çŽ°åœ¨è¯·é’ˆå¯¹è¿™é“é”™é¢˜ï¼Œå¼€å§‹å¼•å¯¼ï¼š
"""


def generate_learning_analysis_prompt(mistakes_data, paper_info=""):
    """ç”Ÿæˆå­¦æƒ…åˆ†æžçš„prompt"""

    mistakes_list = mistakes_data.get("mistakes", [])
    mistake_count = len(mistakes_list)

    prompt = f"""{LEARNING_ANALYSIS_TEMPLATE}

**è¯•å·åŸºæœ¬ä¿¡æ¯ï¼š**
- æ£€æµ‹åˆ°é”™é¢˜æ•°é‡ï¼š{mistake_count}é“
- è¯•å·ä¿¡æ¯ï¼š{paper_info if paper_info else "æ•°å­¦è¯•å·"}

**é”™é¢˜è¯¦æƒ…ï¼š**
"""

    # æ·»åŠ æ¯é“é”™é¢˜çš„è¯¦ç»†ä¿¡æ¯
    for idx, mistake in enumerate(mistakes_list, 1):
        question_no = mistake.get("question_no", f"ç¬¬{idx}é¢˜")
        question = mistake.get("question", "é¢˜ç›®å†…å®¹æœªè¯†åˆ«")
        student_answer = mistake.get("student_answer", "æœªä½œç­”")
        correct_answer = mistake.get("correct_answer", "æœªçŸ¥")
        reason = mistake.get("reason", "ç­”é¢˜é”™è¯¯")
        analysis = mistake.get("analysis", "")

        prompt += f"""
---
**é”™é¢˜{idx}ï¼š**
- é¢˜å·ï¼š{question_no}
- é¢˜ç›®å†…å®¹ï¼š{question}
- å­¦ç”Ÿç­”æ¡ˆï¼š{student_answer}
- æ­£ç¡®ç­”æ¡ˆï¼š{correct_answer}
- é”™è¯¯åŽŸå› ï¼š{reason}
- è¯¦ç»†åˆ†æžï¼š{analysis}
"""

    prompt += """

è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ¨¡æ¿æ ¼å¼ï¼Œç”Ÿæˆè¯¦ç»†çš„å­¦æƒ…åˆ†æžæŠ¥å‘Šã€‚
"""

    return prompt


def generate_mistake_guide_prompt(mistake_data):
    """ç”Ÿæˆé”™é¢˜è®²è§£çš„prompt"""

    question_no = mistake_data.get("question_no", "?")
    question = mistake_data.get("question", "é¢˜ç›®å†…å®¹æœªè¯†åˆ«")
    student_answer = mistake_data.get("student_answer", "æœªä½œç­”")
    correct_answer = mistake_data.get("correct_answer", "æœªçŸ¥")
    reason = mistake_data.get("reason", "ç­”é¢˜é”™è¯¯")

    prompt = f"""{MISTAKE_GUIDE_TEMPLATE}

**é¢˜ç›®ä¿¡æ¯ï¼š**
- é¢˜å·ï¼š{question_no}
- é¢˜ç›®å†…å®¹ï¼š{question}
- å­¦ç”Ÿç­”æ¡ˆï¼š{student_answer}
- æ­£ç¡®ç­”æ¡ˆï¼š{correct_answer}
- é”™è¯¯æ ‡è®°ï¼š{reason}

è¯·é’ˆå¯¹è¿™é“é”™é¢˜ï¼Œå¼€å§‹è‹æ ¼æ‹‰åº•å¼å¼•å¯¼æ•™å­¦ã€‚
"""

    return prompt


def analyze_content_type(detection_result):
    """
    åˆ¤æ–­å†…å®¹ç±»åž‹ï¼šæ•´å¼ è¯•å· vs å•ä¸ªé”™é¢˜

    åˆ¤æ–­ä¾æ®ï¼š
    1. ç”¨æˆ·æ ‡è®°æ•°é‡ï¼šâ‰¥3ä¸ª â†’ æ•´å¼ è¯•å·ï¼Œ1-2ä¸ª â†’ å•ä¸ªé”™é¢˜
    2. æ£€æµ‹åˆ°çš„é”™é¢˜æ•°é‡ï¼šâ‰¥3é“ â†’ æ•´å¼ è¯•å·ï¼Œ1-2é“ â†’ å•ä¸ªé”™é¢˜
    3. å›¾ç‰‡å†…å®¹å¤æ‚åº¦ï¼šå¤šé“é¢˜ç›® â†’ æ•´å¼ è¯•å·
    """
    user_marks_count = detection_result.get("user_marks_count", 0)
    mistakes = detection_result.get("mistakes", [])
    mistake_count = len(mistakes)

    # åˆ¤æ–­é€»è¾‘
    is_full_paper = False
    reason = ""

    if user_marks_count >= 3:
        is_full_paper = True
        reason = f"ç”¨æˆ·æ ‡è®°äº†{user_marks_count}ä¸ªåŒºåŸŸï¼Œåˆ¤æ–­ä¸ºæ•´å¼ è¯•å·åˆ†æž"
    elif mistake_count >= 3:
        is_full_paper = True
        reason = f"æ£€æµ‹åˆ°{mistake_count}é“é”™é¢˜ï¼Œåˆ¤æ–­ä¸ºæ•´å¼ è¯•å·åˆ†æž"
    elif user_marks_count > 0:
        is_full_paper = False
        reason = f"ç”¨æˆ·æ ‡è®°äº†{user_marks_count}ä¸ªåŒºåŸŸï¼Œåˆ¤æ–­ä¸ºå•ä¸ªé”™é¢˜è®²è§£"
    else:
        is_full_paper = False
        reason = f"æ£€æµ‹åˆ°{mistake_count}é“é”™é¢˜ï¼Œåˆ¤æ–­ä¸ºå•ä¸ªé”™é¢˜è®²è§£"

    return {
        "is_full_paper": is_full_paper,
        "reason": reason,
        "recommended_action": "å­¦æƒ…åˆ†æž" if is_full_paper else "é”™é¢˜è®²è§£",
        "confidence": "high" if (user_marks_count >= 3 or mistake_count >= 3) else "medium"
    }


# ç¤ºä¾‹ä½¿ç”¨
if __name__ == "__main__":
    # æµ‹è¯•åˆ¤æ–­é€»è¾‘
    test_cases = [
        {"user_marks_count": 5, "mistakes": [{"question_no": "1"}]},
        {"user_marks_count": 0, "mistakes": [{"question_no": "1"}, {"question_no": "2"}, {"question_no": "3"}]},
        {"user_marks_count": 1, "mistakes": [{"question_no": "1"}]},
    ]

    for case in test_cases:
        result = analyze_content_type(case)
        print(f"è¾“å…¥: {case}")
        print(f"è¾“å‡º: {result}")
        print()
